<?php


namespace App\Tests\Services;


use App\Command\FetchNewsFromNewsApiCommand;
use App\Exceptions\NewsFetchFailedException;
use App\Services\ThirdPartyNewsApiRequesterServiceInterface;
use PHPUnit\Framework\TestCase;
use Psr\Log\LoggerInterface;
use Symfony\Contracts\HttpClient\Exception\ExceptionInterface;
use Symfony\Contracts\HttpClient\Exception\HttpExceptionInterface;
use Throwable;

class FetchNewsFromNewsApiCommandTest extends TestCase
{
    public function testExecuteReturnsArticles()
    {
        $fetchNewsFromNewsApiCommandInstance = $this->getFetchNewsFromNewsApiCommandInstanceForSuccess();
        $articles = $fetchNewsFromNewsApiCommandInstance->execute();

        $this->assertEquals(20, count($articles));
        $this->assertEquals("Walmart wants to hire 150,000 temporary workers as the coronavirus pandemic continues - CNN", $articles[0]->getTitle());
    }

    private function getFetchNewsFromNewsApiCommandInstanceForSuccess()
    {

        $loggerResolver= $this->createMock(LoggerInterface::class);

        $newsApiJsonString = '{"status":"ok","totalResults":38,"articles":[{"source":{"id":"cnn","name":"CNN"},"author":"Rob McLean, CNN Business","title":"Walmart wants to hire 150,000 temporary workers as the coronavirus pandemic continues - CNN","description":"Walmart, the largest private employer in the United States, plans to hire 150,000 temporary workers by the end of May as the coronavirus pandemic continues to sweep through the country.","url":"https://www.cnn.com/2020/03/20/business/walmart-hiring-coronavirus/index.html","urlToImage":"https://cdn.cnn.com/cnnnext/dam/assets/200319211409-walmart-florida-0218-super-tease.jpg","publishedAt":"2020-03-20T05:55:53Z","content":"New York (CNN Business)Walmart, the largest private employer in the United States, plans to hire 150,000 temporaryworkers by the end of May as the coronavirus pandemic continues to sweep through the country.\r\nThe company said it is hiring the associates to wo… [+1952 chars]"},{"source":{"id":null,"name":"Youtube.com"},"author":null,"title":"DeLuca Has a Breakdown - Grey\'s Anatomy - ABC","description":"DeLuca (Giacomo Gianniotti) suspects that a patient is the victim of human trafficking, but when he takes matters into his own hands to stop it, the other su...","url":"https://www.youtube.com/watch?v=YWtbgDXZ9x4","urlToImage":"https://i.ytimg.com/vi/YWtbgDXZ9x4/maxresdefault.jpg","publishedAt":"2020-03-20T05:00:14Z","content":null},{"source":{"id":"associated-press","name":"Associated Press"},"author":"Haruka Nuga","title":"Olympic flame lands in Japan as doubts grow over Tokyo Games - The Associated Press","description":"MATSUSHIMA AIR BASE, Japan (AP) — The Olympic flame arrived in Japan on Friday from Greece in a scaled-down ceremony at an air base in northern Japan. The flame, carried in a special...","url":"https://apnews.com/aab702fecd00c0706c6b895cccff9209","urlToImage":"https://storage.googleapis.com/afs-prod/media/e9d7c24cc1d6413688680294c87f19f2/3000.jpeg","publishedAt":"2020-03-20T04:45:02Z","content":"MATSUSHIMA AIR BASE, Japan (AP) The Olympic flame arrived in Japan on Friday from Greece in a scaled-down ceremony at an air base in northern Japan.\r\nThe flame, carried in a special canister, touched down amid growing doubts if the Tokyo Games can open as sch… [+2940 chars]"},{"source":{"id":null,"name":"Nypost.com"},"author":"Associated Press","title":"LA\'s cannabis dispensaries deemed \'essential\' under emergency coronavirus order - New York Post ","description":"LOS ANGELES — The “safer at home” emergency order just announced by Los Angeles County and the cities within its borders at a Thursday evening news conference requires all indoor malls, shopping ce…","url":"https://nypost.com/2020/03/20/las-cannabis-dispensaries-deemed-essential-under-emergency-coronavirus-order/","urlToImage":"https://thenypost.files.wordpress.com/2020/03/dispensary-edited.jpg?quality=90&strip=all&w=1200","publishedAt":"2020-03-20T04:20:30Z","content":"LOS ANGELES The safer at home emergency order just announced by Los Angeles County and the cities within its borders at a Thursday evening news conference requires all indoor malls, shopping centers, playgrounds and nonessential retail businesses to close eff… [+1232 chars]"},{"source":{"id":"al-jazeera-english","name":"Al Jazeera English"},"author":"Al Jazeera","title":"India hangs four men over 2012 Delhi bus rape and murder - Al Jazeera English","description":"The four men, who were convicted to death in 2013, were executed at New Delhi\'s Tihar Jail.","url":"https://www.aljazeera.com/news/2020/03/india-hangs-men-2012-delhi-bus-rape-murder-200320033644808.html","urlToImage":"https://www.aljazeera.com/mritems/Images/2020/3/20/4906f351d17a4738b5a78f114e355954_18.jpg","publishedAt":"2020-03-20T04:14:41Z","content":"India executed four men on Friday for the gang rape and murder of a woman on a Delhi bus in 2012 that sparked huge nationwide protests and international revulsion.\r\nThe four were hanged before dawn at Tihar Jail in the Indian capital, the head of the prison, … [+3178 chars]"},{"source":{"id":"google-news","name":"Google News"},"author":null,"title":"Gavin Newsom issues statewide stay-at-home order to slow spread of coronavirus - Modesto Bee","description":null,"url":"https://news.google.com/__i/rss/rd/articles/CBMiPWh0dHBzOi8vd3d3LnNhY2JlZS5jb20vbmV3cy9jb3JvbmF2aXJ1cy9hcnRpY2xlMjQxMzU4ODQ2Lmh0bWzSATxodHRwczovL2FtcC5tb2RiZWUuY29tL25ld3MvY2FsaWZvcm5pYS9hcnRpY2xlMjQxMzU4ODQ2Lmh0bWw?oc=5","urlToImage":null,"publishedAt":"2020-03-20T03:42:02Z","content":null},{"source":{"id":"usa-today","name":"USA Today"},"author":"Jeanine Santucci","title":"GOP senators sold off their stocks ahead of coronavirus economic crash, reports say - USA TODAY","description":"Richard Burr and Kelly Loeffler sold off stocks shortly before financial markets plunged because of the coronavirus pandemic, according to reports.","url":"https://www.usatoday.com/story/news/politics/2020/03/19/reports-burr-loeffler-sold-stocks-ahead-coronavirus-marketcrash/2882006001/","urlToImage":"https://www.gannett-cdn.com/-mm-/d8d0774057d19139d16e6ede624d76e89947662d/c=1-0-1365-767/local/-/media/2019/09/11/USATODAY/usatsports/imageforentry66-lup.jpg?width=1600&height=800&fit=crop","publishedAt":"2020-03-20T03:23:28Z","content":"President Donald Trump has continued to refer to coronavirus as the \"Chinese virus,\" causing many to double down on their calls to avoid stigma.\r\nUSA TODAY\r\nWASHINGTON Two reports on Thursday revealed that Republican Sens. Richard Burr, N.C., and Kelly Loeffl… [+4001 chars]"},{"source":{"id":null,"name":"Youtube.com"},"author":null,"title":"More than 13000 people test positive for novel coronavirus in the US - ABC News","description":"Large sporting venues have been transformed into makeshift triage zones in anticipation of an influx of COVID-19 patients.","url":"https://www.youtube.com/watch?v=yML_W5UrtCc","urlToImage":"https://i.ytimg.com/vi/yML_W5UrtCc/maxresdefault.jpg","publishedAt":"2020-03-20T03:15:10Z","content":"[[getSimpleString(data.title)]]\r\n[[getSimpleString(data.description)]]\r\n[[getSimpleString(data.videoCountText)]]"},{"source":{"id":null,"name":"Youtube.com"},"author":null,"title":"Italy\'s novel coronavirus death toll surpasses China\'s - ABC News","description":"Despite Italy’s much smaller size, the country\'s 3,400 deaths surpass China\'s death toll, and Spain\'s number of cases is also exploding.","url":"https://www.youtube.com/watch?v=K4BPSFH3VWU","urlToImage":"https://i.ytimg.com/vi/K4BPSFH3VWU/maxresdefault.jpg","publishedAt":"2020-03-20T02:58:15Z","content":"Despite Italys much smaller size, the country\'s 3,400 deaths surpass China\'s death toll, and Spain\'s number of cases is also exploding."},{"source":{"id":null,"name":"Nytimes.com"},"author":"Tim Arango, Jill Cowan","title":"Gov. Gavin Newsom of California Orders Californians to Stay at Home - The New York Times","description":"In making the announcement, Mr. Newsom has taken the most drastic step of any state leader to slow the spread of the coronavirus.","url":"https://www.nytimes.com/2020/03/19/us/California-stay-at-home-order-virus.html","urlToImage":"https://static01.nyt.com/images/2020/03/19/us/politics/19-filer-newsom/merlin_170637840_58b45545-8a77-4a27-bcd6-95c937f8bb7d-facebookJumbo.jpg","publishedAt":"2020-03-20T02:48:00Z","content":"Just before Mr. Newsom spoke, officials in Los Angeles County held a news conference to announce their own stay at home order, which they are calling safer at home.\r\nHow the orders will be enforced is unclear, but officials said that they expected residents t… [+1350 chars]"},{"source":{"id":null,"name":"Marketwatch.com"},"author":"Therese Poletti","title":"It’s time for Uber and Lyft to trade differently, because the coronavirus outbreak is affecting them differently - MarketWatch","description":"Lyft does not have as much financial heft, diversified businesses nor international operations to weather the economic storm in the same manner as Uber","url":"http://www.marketwatch.com/story/its-time-for-uber-and-lyft-to-trade-differently-because-the-coronavirus-outbreak-is-affecting-them-differently-2020-03-19","urlToImage":"https://s.marketwatch.com/public/resources/images/MW-HN050_uber_l_ZG_20190710123525.jpg","publishedAt":"2020-03-20T02:40:00Z","content":"Uber Technologies Inc. passed along some optimistic news on Thursday, and sent its stock soaring. Rival Lyft Inc. also jumped, as has been the case largely since they entered the public markets in close proximity.In the current environment, though, these two … [+4627 chars]"},{"source":{"id":null,"name":"Cbssports.com"},"author":"","title":"NFL Free Agency 2020: Biggest winners and losers on Day 2 of the new league year - CBS Sports","description":"Darius Slay (and the Browns) come out big winners, while Todd Gurley misses out on a huge portion of his contract","url":"https://www.cbssports.com/nfl/news/nfl-free-agency-2020-biggest-winners-and-losers-on-day-2-of-the-new-league-year/","urlToImage":"https://sportshub.cbsistatic.com/i/r/2017/09/28/07e27773-0651-474c-a5a2-ae42955b104c/thumbnail/1200x675/a15857c4762e698e41f2fbfd16b9a9e2/usatsi-10304541-1.jpg","publishedAt":"2020-03-20T02:36:37Z","content":"We\'re two days into the NFL season and the top free agents are coming off the board. Sure there are plenty of good players to be had, but the best players may be on the trade market (Brandin Cooks, Yannick Ngakoue) after the first wave of free agency is comin… [+5161 chars]"},{"source":{"id":null,"name":"Syracuse.com"},"author":"Ryan Talbot | rtalbot@nyup.com","title":"Buffalo Bills WR Stefon Diggs’ conversation with Todd Gurley has Bills Mafia’s attention - syracuse.com","description":"Gurley was released by the Rams on Thursday.","url":"https://www.syracuse.com/buffalo-bills/2020/03/buffalo-bills-wr-stefon-diggs-conversation-with-todd-gurley-has-bills-mafias-attention.html","urlToImage":"https://www.syracuse.com/resizer/vZ8gp-dgwev7EPnD2s8oev-Xsfg=/1280x0/smart/arc-anglerfish-arc2-prod-advancelocal.s3.amazonaws.com/public/XRYHS2FKUBE6DGFOKFDM2XVPN4.jpg","publishedAt":"2020-03-20T02:35:08Z","content":"Stefon Diggs has not been a member of the Buffalo Bills for long, but it appears that he may already be recruiting players.\r\nOn Thursday, Diggs was taken by surprise over the Los Angeles Rams releasing Todd Gurley.\r\nWhen Gurley made a reference to the movie F… [+1319 chars]"},{"source":{"id":null,"name":"Nbcsports.com"},"author":"https://www.facebook.com/DZangaroCSN/","title":"Darius Slay explains why he lost respect for Lions head coach - NBCSports.com","description":"Cornerback Darius Slay detailed his fractured relationship with Lions head coach Matt Patricia, making his departure from the team more clear. By Dave Zangaro","url":"https://www.nbcsports.com/philadelphia/eagles/eagles-darius-slay-explains-lost-respect-lions-head-coach-matt-patricia","urlToImage":"https://www.nbcsports.com/philadelphia/sites/csnphilly/files/2020/03/19/usatsi_13849791_1.jpg","publishedAt":"2020-03-20T02:31:32Z","content":"As the rest of the country has been dealing with the spread of the coronavirus, the NFL forged on with free agency. \r\nIts been a much-needed distraction for some but it definitely hasnt been normal. \r\nAnd on Thursday, we got another reminder of that. \r\nSaints… [+4095 chars]"},{"source":{"id":"cnbc","name":"CNBC"},"author":"Lauren Hirsch","title":"Senate GOP coronavirus bailout bill caps executive pay at $425,000 - CNBC","description":"The Republican bill would cap executive pay at bailed-out firms, while also allowing the government to take ownership stakes. Democrats are pushing for more restrictions.","url":"https://www.cnbc.com/2020/03/19/coronavirus-bailout-senate-gop-bill-caps-executive-salaries-at-425000.html","urlToImage":"https://image.cnbcfm.com/api/v1/image/106452902-1584666752308gettyimages-1207531414.jpeg?v=1584666830","publishedAt":"2020-03-20T02:17:23Z","content":"Executives at companies that would receive bailout cash from the coronavirus-relief bill unveiled by Senate Republicans on Thursday would see their annual compensation capped at $425,000 for two years.\r\nThe legislation would also allow the government a chance… [+3675 chars]"},{"source":{"id":null,"name":"Benzinga.com"},"author":"Neer Varshney","title":"Tesla To Shut Down Fremont Factory Due To Coronavirus, Says It Has Enough Cash To Survive - Benzinga","description":"Tesla Inc. (NASDAQ: TSLA) will temporarily suspend production starting Monday at its Fremont factory as local authorities imposed restrictions on businesses ...","url":"https://www.benzinga.com/news/20/03/15613659/tesla-to-shut-down-fremont-factory-due-to-coronavirus-says-it-has-enough-cash-to-survive","urlToImage":"https://cdn2.benzinga.com/files/imagecache/og_image_social_share_1200x630/images/story/2012/screen_shot_2020-03-19_at_10.02.27_pm.png","publishedAt":"2020-03-20T02:06:00Z","content":"Tesla Inc. (NASDAQ: TSLA) will temporarily suspend production starting Monday at its Fremont factory as local authorities imposed restrictions on businesses to curb the novel coronavirus (COVID-19) outbreak.\r\nWhat Happened\r\nIn a statement late Thursday, Tesla… [+2527 chars]"},{"source":{"id":null,"name":"Clickondetroit.com"},"author":"Amber Ainsworth","title":"2 Michigan State University students test positive for coronavirus (COVID-19) - WDIV ClickOnDetroit","description":"Two Michigan State University students have coronavirus (COVID-19), officials announced Thursday.","url":"https://www.clickondetroit.com/news/local/2020/03/20/2-michigan-state-university-students-test-positive-for-coronavirus-covid-19/","urlToImage":"https://www.clickondetroit.com/resizer/6tr_czkFfZG0Xq78HMvN9_a3ZWI=/640x359/smart/filters:format(jpeg):strip_exif(true):strip_icc(true):no_upscale(true):quality(65)/arc-anglerfish-arc2-prod-gmg.s3.amazonaws.com/public/ALDVO7OENRD2PJEU3BFGVDXKFU.jpg","publishedAt":"2020-03-20T01:55:08Z","content":"EAST LANSING, Mich. Two Michigan State University students have coronavirus (COVID-19), officials announced Thursday.\r\nMORE: Heres which Michigan counties have confirmed cases of coronavirus\r\nAccording to the Ingham County Health Department, the two cases are… [+3221 chars]"},{"source":{"id":"cnn","name":"CNN"},"author":"Daniel Dale","title":"Fact check: Trump wrongly claims FDA \'approved\' drug chloroquine to treat the coronavirus - CNN","description":"President Donald Trump claimed during a White House briefing on Thursday that the Food and Drug Administration had approved the \"very powerful\" drug chloroquine to treat coronavirus.","url":"https://www.cnn.com/2020/03/19/politics/fact-check-chloroquine-trump-fda/index.html","urlToImage":"https://cdn.cnn.com/cnnnext/dam/assets/200319145233-02-trump-presser-0319-super-tease.jpg","publishedAt":"2020-03-20T01:51:00Z","content":"Washington (CNN)President Donald Trump claimed during a White House briefing on Thursday that the Food and Drug Administration had approved the \"very powerful\" drug chloroquine to treat coronavirus.\r\nChloroquine is used to treat malaria, lupus and rheumatoid … [+2460 chars]"},{"source":{"id":null,"name":"Sciencealert.com"},"author":"Tessa Koumoundouros","title":"This \'Wonderchicken\' Could Be The Oldest Modern Bird Fossil, And a True Survivor - ScienceAlert","description":"Back when fearsome dinosaurs roamed the land, an unimpressive avian, about the size of a very small duck, somehow survived alongside them - eking out a life along a prehistoric European seashore.","url":"https://www.sciencealert.com/oldest-modern-bird-fossil-holds-clues-to-how-birds-survived-when-other-dinosaurs-did-not","urlToImage":"https://www.sciencealert.com/images/2020-03/processed/TeenyWonderchickenMightierThanDinos_1024.jpg","publishedAt":"2020-03-20T01:37:11Z","content":"Back when fearsome dinosaurs roamed the land, an unimpressive avian, about the size of a very small duck, somehow survived alongside them - eking out a life along a prehistoric European seashore.\r\nIt had the long slender legs of a shorebird, and a face like a… [+3005 chars]"},{"source":{"id":null,"name":"Gamespot.com"},"author":"Kevin Knezevic","title":"Animal Crossing And Doom Eternal Deliveries From Amazon Could Be Delayed - GameSpot","description":"The online retailer has sent notifications to customers that there may be a delay in their game orders as the company prioritizes shipping out household and medical items.","url":"https://www.gamespot.com/articles/animal-crossing-and-doom-eternal-deliveries-from-a/1100-6474983/","urlToImage":"https://gamespot1.cbsistatic.com/uploads/screen_kubrick/1578/15787979/3637918-acnh-05.jpg","publishedAt":"2020-03-20T01:28:00Z","content":"The ongoing COVID-19 (coronavirus) pandemic may cause some disruptions in Amazon\'s shipments of Animal Crossing: New Horizons and Doom Eternal, the retailer has confirmed. Customers who have pre-ordered either title through the online retailer have been recei… [+1437 chars]"}]}';
        $newsApiRequesterResolver= $this->createMock(ThirdPartyNewsApiRequesterServiceInterface::class);
        $newsApiRequesterResolver
            ->expects($this->once())
            ->method('request')
            ->will($this->returnValue($newsApiJsonString));

        return new FetchNewsFromNewsApiCommand(
            $loggerResolver,
            $newsApiRequesterResolver
        );
    }

    public function testExecuteThrowsNewsFetchFailedExceptionWhenHttpExceptionInterface()
    {
        $clientExceptionMock = $this->createMock(HttpExceptionInterface::class);
        $this->expectException(NewsFetchFailedException::class);

        $fetchNewsFromNewsApiCommandInstance = $this->getFetchNewsFromNewsApiCommandInstanceForException($clientExceptionMock);
        $fetchNewsFromNewsApiCommandInstance->execute();
    }

    public function testExecuteThrowsNewsFetchFailedExceptionWhenExceptionInterface()
    {
        $clientExceptionMock = $this->createMock(ExceptionInterface::class);
        $this->expectException(NewsFetchFailedException::class);

        $fetchNewsFromNewsApiCommandInstance = $this->getFetchNewsFromNewsApiCommandInstanceForException($clientExceptionMock);
        $fetchNewsFromNewsApiCommandInstance->execute();
    }

    private function getFetchNewsFromNewsApiCommandInstanceForException(Throwable $httpException)
    {
        $loggerResolver= $this->createMock(LoggerInterface::class);
        $loggerResolver
            ->expects($this->once())
            ->method('error');

        $newsApiRequesterResolver= $this->createMock(ThirdPartyNewsApiRequesterServiceInterface::class);
        $newsApiRequesterResolver
            ->expects($this->once())
            ->method('request')
            ->will($this->throwException($httpException));

        return new FetchNewsFromNewsApiCommand(
            $loggerResolver,
            $newsApiRequesterResolver
        );
    }
}